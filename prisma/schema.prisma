generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
}

model User {
  id            String    @id @default(cuid())
  name          String?
  nickname      String?
  email         String?   @unique
  emailVerified DateTime?
  passwordHash  String?
  image         String?
  baseCurrency  String    @default("USD")
  language      String    @default("en")
  gender        String    @default("male")
  isAdmin       Boolean   @default(false)
  isDisabled    Boolean   @default(false)
  lastLoginAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // Plan and entitlements
  plan                 String?   @default("free")
  receiptScansUsed     Int       @default(0)
  receiptScansResetAt  DateTime?

  ownedTrips         Trip[]
  memberships        TripMember[]
  expenses           Expense[]
  accounts           Account[]
  sessions           Session[]
  verificationTokens EmailVerificationToken[]
  achievements       UserAchievement[]
  invitations        TripInvitation[]
}

enum TripType {
  SOLO
  COUPLE
  FAMILY
  FRIENDS
}

enum TravelStyle {
  BUDGET
  BALANCED
  COMFORT
  LUXURY
}

enum AgeRange {
  AGE_18_25
  AGE_26_35
  AGE_36_45
  AGE_46_60
  AGE_60_PLUS
}

model Trip {
  id         String    @id @default(cuid())
  ownerId    String
  name       String
  startDate  DateTime?
  endDate    DateTime?
  countries  String[]
  baseCurrency String  @default("USD")
  currentCountry String?
  currentCurrency String?
  tripType   TripType?
  adults     Int?
  children   Int?
  travelStyle TravelStyle?
  ageRange   AgeRange?
  targetBudget Float?
  isClosed   Boolean   @default(false)
  closedAt   DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  owner       User             @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  members     TripMember[]
  expenses    Expense[]
  invitations TripInvitation[]

  @@index([ownerId])
}

enum MemberRole {
  OWNER
  EDITOR
  VIEWER
}

model TripMember {
  id        String     @id @default(cuid())
  tripId    String
  userId    String
  role      MemberRole
  createdAt DateTime   @default(now())

  trip Trip @relation(fields: [tripId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([tripId, userId])
  @@index([tripId])
  @@index([userId])
}

model Expense {
  id              String    @id @default(cuid())
  tripId          String
  createdById     String
  title           String
  category        String
  countryCode     String
  currency        String
  amount          Float
  convertedAmount Float?
  fxRate          Float?
  fxDate          DateTime?
  manualRateToBase Float?
  expenseDate     DateTime
  usageDate       DateTime?
  nights          Int?
  note            String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  trip      Trip @relation(fields: [tripId], references: [id], onDelete: Cascade)
  createdBy User @relation(fields: [createdById], references: [id], onDelete: Cascade)

  @@index([tripId])
  @@index([createdById])
  @@index([expenseDate])
}

// NextAuth.js Models
model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model EmailVerificationToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expires   DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model ExchangeRateCache {
  id           String   @id @default(cuid())
  baseCurrency String
  date         String   // YYYY-MM-DD format
  ratesJson    String   // JSON map of currency -> rate
  fetchedAt    DateTime @default(now())
  createdAt    DateTime @default(now())

  @@unique([baseCurrency, date])
  @@index([baseCurrency])
  @@index([date])
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  DECLINED
  REVOKED
}

model TripInvitation {
  id            String           @id @default(cuid())
  tripId        String
  invitedEmail  String?
  invitedUserId String?
  token         String           @unique @default(cuid())
  role          MemberRole
  status        InvitationStatus @default(PENDING)
  createdAt     DateTime         @default(now())
  expiresAt     DateTime
  acceptedAt    DateTime?

  trip        Trip  @relation(fields: [tripId], references: [id], onDelete: Cascade)
  invitedUser User? @relation(fields: [invitedUserId], references: [id], onDelete: SetNull)

  @@index([tripId])
  @@index([invitedEmail])
  @@index([token])
  @@index([invitedUserId])
}

enum AchievementKey {
  FIRST_EXPENSE_LOGGED
  EXPENSES_ON_3_DAYS
  TEN_EXPENSES_LOGGED
  FIRST_TRIP_COMPLETED
  THREE_TRIPS_LOGGED
  EXPENSES_IN_2_COUNTRIES
}

model UserAchievement {
  id         String         @id @default(cuid())
  userId     String
  key        AchievementKey
  unlockedAt DateTime       @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, key])
  @@index([userId])
}
